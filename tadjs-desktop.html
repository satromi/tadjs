<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TADjs Desktop</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="tadjs-desktop.css">
</head>
<body>
    <!-- メインデスクトップ環境 -->
    <div id="desktop" class="desktop">
        <!-- 初期表示の仮身一覧ウインドウ（windowContainerに移動） -->

        <!-- ウインドウコンテナ -->
        <div id="window-container" class="window-container">
            <!-- 動的に生成されるウインドウがここに表示される -->
        </div>

        <!-- コンテキストメニュー -->
        <div id="context-menu" class="context-menu" style="display: none;">
            <div class="menu-item" data-action="open">開く</div>
            <div class="menu-separator"></div>
            <div class="menu-item" data-action="properties">プロパティ</div>
        </div>

        <!-- ダイアログオーバーレイ -->
        <div id="dialog-overlay" class="dialog-overlay" style="display: none;"></div>

        <!-- メッセージダイアログ -->
        <div id="message-dialog" class="btron-dialog" style="display: none;">
            <div class="dialog-message" id="dialog-message-text"></div>
            <div class="dialog-buttons" id="dialog-message-buttons"></div>
        </div>

        <!-- 入力ダイアログ -->
        <div id="input-dialog" class="btron-dialog" style="display: none;">
            <div class="dialog-message" id="input-dialog-message"></div>
            <input type="text" class="dialog-input" id="dialog-input-field" />
            <div class="dialog-buttons" id="input-dialog-buttons"></div>
        </div>
    </div>

    <!-- ステータスバー -->
    <div id="status-bar" class="status-bar">
        <div class="status-message" id="status-message">システム準備完了</div>
        <div class="status-time" id="status-time"></div>
    </div>

    <!-- スクリプト -->
    <script src="encoding.min.js?v=20251024"></script>
    <script src="lh5.js"></script>
    <!-- ロガーをグローバル変数として読み込み（tad.js等で使用） -->
    <script type="module">
        import { getLogger, LogLevel, logManager } from './js/logger.js';
        window.getLogger = getLogger;
        window.LogLevel = LogLevel;
        window.logManager = logManager;
    </script>
    <script type="module" src="tad.js?v=20251024"></script>
    <script src="electron/plugin-manager.js"></script>
    <!-- MessageBus Phase 2: 親モード用にMessageBusをグローバル変数として読み込み -->
    <script type="module">
        import { MessageBus } from './js/message-bus.js';
        window.MessageBus = MessageBus;
    </script>
    <!-- MessageRouter Phase 1: メッセージルーティング機構 -->
    <script type="module">
        import { MessageRouter } from './js/message-router.js';
        window.MessageRouter = MessageRouter;
    </script>
    <!-- ScrollbarManager: スクロールバー管理 -->
    <script type="module">
        import { ScrollbarManager } from './js/scrollbar-manager.js';
        window.ScrollbarManager = ScrollbarManager;
    </script>
    <!-- DialogManager: ダイアログ管理 -->
    <script type="module">
        import { DialogManager } from './js/dialog-manager.js';
        window.DialogManager = DialogManager;
    </script>
    <!-- WindowManager: ウィンドウ管理 -->
    <script type="module">
        import { WindowManager } from './js/window-manager.js';
        window.WindowManager = WindowManager;
    </script>
    <!-- ContextMenuManager: コンテキストメニュー管理 -->
    <script type="module">
        import { ContextMenuManager } from './js/context-menu-manager.js';
        window.ContextMenuManager = ContextMenuManager;
    </script>
    <!-- ToolPanelManager: ツールパネル管理 -->
    <script type="module">
        import { ToolPanelManager } from './js/tool-panel-manager.js';
        window.ToolPanelManager = ToolPanelManager;
    </script>
    <!-- FileManager: ファイル操作管理 -->
    <script type="module">
        import { FileManager } from './js/file-manager.js';
        window.FileManager = FileManager;
    </script>
    <!-- UISettingsManager: UI設定管理 -->
    <script type="module">
        import { UISettingsManager } from './js/ui-settings-manager.js';
        window.UISettingsManager = UISettingsManager;
    </script>
    <!-- 実身仮身システムをグローバル変数として読み込み -->
    <script type="module">
        import { RealObjectSystem } from './js/real-object-system.js';
        window.RealObjectSystem = RealObjectSystem;
    </script>
    <!-- 共通定数とユーティリティをグローバル変数として読み込み -->
    <script type="module">
        import {
            UI_UPDATE_DELAY_MS,
            QUICK_UI_UPDATE_DELAY_MS,
            DEFAULT_INPUT_WIDTH,
            MIN_WINDOW_WIDTH,
            MIN_WINDOW_HEIGHT,
            MIN_SCROLLBAR_THUMB_SIZE,
            DESKTOP_BG_COLOR,
            SCROLLBAR_THUMB_COLOR,
            HOVER_BG_COLOR,
            DIALOG_BG_COLOR,
            BORDER_COLOR,
            ICON_SET_DELAY_MS,
            SCROLL_UPDATE_DELAY_MS,
            MENU_FETCH_TIMEOUT_MS,
            STATUS_UPDATE_INTERVAL_MS,
            STATUS_MESSAGE_DURATION_MS,
            CONTEXT_MENU_FLAG_CLEAR_MS,
            DOUBLE_CLICK_TIME_MS,
            RETRY_DELAY_MS,
            CLICK_DEBOUNCE_DELAY_MS,
            WINDOW_CLOSE_CLEANUP_DELAY_MS,
            ANIMATION_COMPLETE_DELAY_MS,
            DIALOG_TIMEOUT_MS,
            escapeHtml
        } from './js/util.js';
        window.UI_UPDATE_DELAY_MS = UI_UPDATE_DELAY_MS;
        window.QUICK_UI_UPDATE_DELAY_MS = QUICK_UI_UPDATE_DELAY_MS;
        window.DEFAULT_INPUT_WIDTH = DEFAULT_INPUT_WIDTH;
        window.MIN_WINDOW_WIDTH = MIN_WINDOW_WIDTH;
        window.MIN_WINDOW_HEIGHT = MIN_WINDOW_HEIGHT;
        window.MIN_SCROLLBAR_THUMB_SIZE = MIN_SCROLLBAR_THUMB_SIZE;
        window.DESKTOP_BG_COLOR = DESKTOP_BG_COLOR;
        window.SCROLLBAR_THUMB_COLOR = SCROLLBAR_THUMB_COLOR;
        window.HOVER_BG_COLOR = HOVER_BG_COLOR;
        window.DIALOG_BG_COLOR = DIALOG_BG_COLOR;
        window.BORDER_COLOR = BORDER_COLOR;
        window.ICON_SET_DELAY_MS = ICON_SET_DELAY_MS;
        window.SCROLL_UPDATE_DELAY_MS = SCROLL_UPDATE_DELAY_MS;
        window.MENU_FETCH_TIMEOUT_MS = MENU_FETCH_TIMEOUT_MS;
        window.STATUS_UPDATE_INTERVAL_MS = STATUS_UPDATE_INTERVAL_MS;
        window.STATUS_MESSAGE_DURATION_MS = STATUS_MESSAGE_DURATION_MS;
        window.CONTEXT_MENU_FLAG_CLEAR_MS = CONTEXT_MENU_FLAG_CLEAR_MS;
        window.DOUBLE_CLICK_TIME_MS = DOUBLE_CLICK_TIME_MS;
        window.RETRY_DELAY_MS = RETRY_DELAY_MS;
        window.CLICK_DEBOUNCE_DELAY_MS = CLICK_DEBOUNCE_DELAY_MS;
        window.WINDOW_CLOSE_CLEANUP_DELAY_MS = WINDOW_CLOSE_CLEANUP_DELAY_MS;
        window.ANIMATION_COMPLETE_DELAY_MS = ANIMATION_COMPLETE_DELAY_MS;
        window.DIALOG_TIMEOUT_MS = DIALOG_TIMEOUT_MS;
        window.escapeHtml = escapeHtml;
    </script>
    <!-- ファイルインポートマネージャーを読み込み -->
    <script type="module" src="./js/fileimport.js"></script>
    <script type="module" src="tadjs-desktop.js"></script>
    <script>
        // プラグインマネージャーとTADjsDesktopを順番に初期化
        document.addEventListener('DOMContentLoaded', async () => {
            // まずプラグインマネージャーを初期化
            window.pluginManager = new PluginManager();
            await window.pluginManager.initialize();
            console.log('プラグインマネージャーを初期化しました');

            // 次にTADjsDesktopを初期化（プラグインマネージャーの後）
            window.tadjsDesktop = new TADjsDesktop();
            console.log('TADjs Desktopを初期化しました');

            // メニューバーの自動表示/非表示処理
            if (window.require) {
                const { ipcRenderer } = window.require('electron');
                let menuVisible = false;

                // マウス移動イベント
                document.addEventListener('mousemove', (e) => {
                    // ウィンドウ上部10px以内にマウスがある場合
                    if (e.clientY <= 10) {
                        if (!menuVisible) {
                            menuVisible = true;
                            ipcRenderer.send('set-menu-bar-visibility', true);
                        }
                    } else if (e.clientY > 10 && menuVisible) {
                        // マウスが上部10pxから離れたらすぐに非表示
                        menuVisible = false;
                        ipcRenderer.send('set-menu-bar-visibility', false);
                    }
                });
            }
        });
    </script>
</body>
</html>