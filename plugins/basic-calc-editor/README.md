# 基本表計算プラグイン

BTRON風の表計算（スプレッドシート）プラグインです。TAD形式のファイルとして保存・読み込みができます。

## 機能概要

### 基本機能
- **グリッド編集**: セルの値を直接編集
- **数式計算**: `=` で始まる数式を入力して自動計算
- **セル参照**: A1形式または[行,列]形式でセルを参照
- **循環参照検出**: セルの循環参照を自動的に検出してエラー表示
- **コピー＆ペースト**: セルの内容、数式、スタイル、仮身をコピー/貼り付け
- **行・列のリサイズ**: ドラッグで行の高さ、列の幅を調整
- **仮身（Virtual Object）操作**: 実身へのリンク（仮身）をセルに配置・操作

### 仮身操作
- **ドラッグ＆ドロップ**: セル間、他のウィンドウとの間で仮身を移動
- **仮身コピー**: 左クリックドラッグ中に右クリックでコピーモード
- **ダブルクリック起動**: 仮身をダブルクリックして実身を開く
- **ダブルクリックドラッグ**: 仮身をダブルクリックドラッグして実身を複製

## 使い方

### セルの編集

1. **値の入力**: セルをクリックして直接入力
2. **数式の入力**: `=` で始まる数式を入力
   - 例: `=A1+B1`
   - 例: `=10*3.14`
3. **編集の確定**: Enterキーまたは他のセルをクリック

### 数式の書き方

#### 基本的な算術演算

数式は `=` で始めます。JavaScriptの算術式をそのまま使用できます。

```
=10+20           // 加算
=100-25          // 減算
=5*6             // 乗算
=100/4           // 除算
=10%3            // 剰余
=2**8            // べき乗（2の8乗）
```

#### セル参照

##### A1形式（推奨）
```
=A1              // A1セルの値
=A1+B1           // A1とB1の値を足す
=C2*D3           // C2とD3の値を掛ける
```

##### [行,列]形式（BTRON互換）
```
=[1,1]           // 1行1列のセルの値
=[1,1]+[1,2]     // 1行1列と1行2列の値を足す
```

#### 範囲参照

セルの範囲を指定できます（コロン記法）：

```
=SUM(A1:A10)         // A1からA10までの合計
=AVERAGE(B1:B5)      // B1からB5までの平均
=MAX(C1:C10)         // C1からC10までの最大値
=COUNT(A1:D10)       // A1からD10までの数値セルの個数
```

#### 利用可能な関数

Formula.js（Microsoft Excel互換の399個の関数）とJavaScriptの標準関数が使用できます。

##### 1. 統計関数

**集計関数**
```
=SUM(A1:A10)              // 合計
=AVERAGE(A1:A10)          // 平均
=COUNT(A1:A10)            // 数値セルの個数
=MAX(A1:A10)              // 最大値
=MIN(A1:A10)              // 最小値
=MEDIAN(A1:A10)           // 中央値
=MODE.SNGL(A1:A10)        // 最頻値
```

**分散・標準偏差**
```
=STDEV.S(A1:A10)          // 標本標準偏差
=STDEV.P(A1:A10)          // 母集団標準偏差
=VAR.S(A1:A10)            // 標本分散
=VAR.P(A1:A10)            // 母集団分散
```

**順位・パーセンタイル**
```
=RANK(A1, A1:A10)         // 順位
=PERCENTILE(A1:A10, 0.9)  // 90パーセンタイル
=QUARTILE(A1:A10, 1)      // 第1四分位数
```

##### 2. 数学・三角関数

**基本的な数学関数**
```
=ABS(-5)                  // 絶対値 → 5
=SQRT(16)                 // 平方根 → 4
=POWER(2, 10)             // べき乗 → 1024
=ROUND(3.7, 0)            // 四捨五入 → 4
=FLOOR(3.7, 1)            // 切り捨て → 3
=CEILING(3.2, 1)          // 切り上げ → 4
=MOD(10, 3)               // 剰余 → 1
```

**三角関数**
```
=SIN(PI()/2)              // サイン → 1
=COS(0)                   // コサイン → 1
=TAN(PI()/4)              // タンジェント → 1
=ASIN(1)                  // アークサイン
=ACOS(0)                  // アークコサイン
=ATAN(1)                  // アークタンジェント
=ATAN2(1, 1)              // 2引数アークタンジェント
```

**その他の数学関数**
```
=EXP(1)                   // e^x
=LN(10)                   // 自然対数
=LOG10(100)               // 常用対数 → 2
=LOG(8, 2)                // 底2の対数 → 3
=FACT(5)                  // 階乗 → 120
=GCD(12, 18)              // 最大公約数 → 6
=LCM(4, 6)                // 最小公倍数 → 12
```

**定数**
```
=PI()                     // 円周率 π → 3.141592653589793
=E()                      // 自然対数の底 e → 2.718281828459045
```

##### 3. 論理関数

```
=IF(A1>10, "大", "小")     // 条件分岐
=AND(A1>0, B1>0)          // AND条件
=OR(A1>0, B1>0)           // OR条件
=NOT(A1>0)                // NOT条件
=IFS(A1>90, "A", A1>80, "B", A1>70, "C")  // 複数条件
=SWITCH(A1, 1, "月", 2, "火", 3, "水")     // 値による分岐
```

##### 4. テキスト関数

**文字列結合・抽出**
```
=CONCATENATE("Hello", " ", "World")  // 文字列結合
=TEXTJOIN(",", TRUE, A1:A5)          // 区切り文字で結合
=LEFT("Hello", 2)                     // 左から2文字 → "He"
=RIGHT("Hello", 2)                    // 右から2文字 → "lo"
=MID("Hello", 2, 3)                   // 2文字目から3文字 → "ell"
=LEN("Hello")                         // 文字数 → 5
```

**大文字・小文字変換**
```
=UPPER("hello")           // 大文字変換 → "HELLO"
=LOWER("HELLO")           // 小文字変換 → "hello"
=PROPER("hello world")    // 単語の先頭を大文字 → "Hello World"
```

**検索・置換**
```
=FIND("l", "Hello")       // 検索（大文字小文字区別） → 3
=SEARCH("L", "Hello")     // 検索（大文字小文字区別なし） → 3
=REPLACE("Hello", 1, 2, "J")  // 置換 → "Jello"
=SUBSTITUTE("Hello", "l", "r")  // 置換 → "Herro"
```

**その他**
```
=TRIM("  Hello  ")        // 前後の空白削除 → "Hello"
=REPT("*", 5)             // 繰り返し → "*****"
=TEXT(1234, "0000")       // 数値を書式付き文字列に → "1234"
```

##### 5. 日付・時刻関数

**日付の生成**
```
=DATE(2025, 1, 15)        // 日付を生成
=TIME(14, 30, 0)          // 時刻を生成
=NOW()                    // 現在の日時
=TODAY()                  // 今日の日付
```

**日付の分解**
```
=YEAR(NOW())              // 年を取得
=MONTH(NOW())             // 月を取得
=DAY(NOW())               // 日を取得
=HOUR(NOW())              // 時を取得
=MINUTE(NOW())            // 分を取得
=SECOND(NOW())            // 秒を取得
=WEEKDAY(NOW())           // 曜日を取得（1=日曜）
```

**日付計算**
```
=DAYS(DATE(2025,12,31), DATE(2025,1,1))  // 日数差
=NETWORKDAYS(開始日, 終了日)              // 営業日数
=WORKDAY(開始日, 日数)                    // 営業日加算
=EDATE(NOW(), 3)                         // 3ヶ月後の日付
```

##### 6. 検索・参照関数

```
=VLOOKUP(検索値, 範囲, 列番号, FALSE)    // 垂直検索
=HLOOKUP(検索値, 範囲, 行番号, FALSE)    // 水平検索
=INDEX(範囲, 行, 列)                      // 位置から値を取得
=MATCH(検索値, 範囲, 0)                   // 値の位置を検索
```

##### 7. 財務関数

**ローン・投資計算**
```
=PMT(金利, 期間, 現在価値)                // 定期支払額
=FV(金利, 期間, 支払額)                   // 将来価値
=PV(金利, 期間, 支払額)                   // 現在価値
=RATE(期間, 支払額, 現在価値)             // 利率
=NPER(金利, 支払額, 現在価値)             // 期間
```

**投資評価**
```
=NPV(割引率, キャッシュフロー範囲)        // 正味現在価値
=IRR(キャッシュフロー範囲)                // 内部収益率
```

##### 8. 情報関数

**型チェック**
```
=ISNUMBER(A1)             // 数値か判定
=ISTEXT(A1)               // テキストか判定
=ISBLANK(A1)              // 空白か判定
=ISERROR(A1)              // エラーか判定
=ISEVEN(A1)               // 偶数か判定
=ISODD(A1)                // 奇数か判定
```

##### 9. エンジニアリング関数

**基数変換**
```
=BIN2DEC("1010")          // 2進数→10進数 → 10
=DEC2BIN(10)              // 10進数→2進数 → "1010"
=DEC2HEX(255)             // 10進数→16進数 → "FF"
=HEX2DEC("FF")            // 16進数→10進数 → 255
```

**複素数演算**
```
=COMPLEX(3, 4)            // 複素数生成 → "3+4i"
=IMSUM("3+4i", "1-2i")    // 複素数加算
=IMPRODUCT("3+4i", "1-2i")  // 複素数乗算
```

##### 10. JavaScript標準関数

JavaScriptの`Math`オブジェクトも使用可能：

```
=Math.random()            // 0以上1未満の乱数
=Math.floor(Math.random()*100)  // 0〜99の整数乱数
=Math.sign(-5)            // 符号 → -1
=Math.trunc(3.7)          // 整数部のみ → 3
```

#### 複合的な数式の例

**範囲参照を使った集計**
```
=SUM(A1:A10)                        // A1からA10の合計
=AVERAGE(B1:B20)                    // B1からB20の平均
=MAX(C1:C100)                       // C1からC100の最大値
=COUNT(D1:D50)                      // D1からD50の数値セル数
=STDEV.S(E1:E30)                    // E1からE30の標準偏差
```

**条件分岐**
```
=IF(A1>80, "合格", "不合格")        // 点数による判定
=IF(A1="", 0, A1*1.1)               // 空セルをゼロとして扱う
=IFS(A1>=90, "A", A1>=80, "B", A1>=70, "C", TRUE, "D")  // 段階評価
```

**数学計算**
```
=SQRT(POWER(A1,2) + POWER(B1,2))    // ピタゴラスの定理
=ROUND(A1*1.08, 0)                  // 税込価格（四捨五入）
=MOD(A1, 2) = 0                     // 偶数判定
=RANDBETWEEN(1, 6)                  // サイコロ（1〜6の乱数）
```

**テキスト処理**
```
=CONCATENATE(A1, " ", B1)           // 姓名を結合
=UPPER(A1)                          // 大文字に変換
=LEN(A1) > 10                       // 10文字以上か判定
=SUBSTITUTE(A1, "旧", "新")         // 文字列置換
```

**日付計算**
```
=YEAR(NOW())                        // 現在の年
=DAYS(TODAY(), A1)                  // A1からの経過日数
=DATE(2025, 12, 31)                 // 特定の日付
=WEEKDAY(TODAY())                   // 今日の曜日（1=日曜）
```

**財務計算**
```
=PMT(0.05/12, 360, -30000000)       // 月々のローン返済額（年利5%、30年、3000万円）
=FV(0.03/12, 120, -50000)           // 積立投資の将来価値（年利3%、10年、月5万円）
```

#### エラー表示

- `#ERROR!`: 数式の構文エラーまたは計算エラー
- `#CIRCULAR!`: 循環参照が検出された場合

### コピー＆ペースト

#### セルのコピー
1. コピー元のセルを選択
2. `Ctrl+C` でコピー
3. コピー先のセルを選択
4. `Ctrl+V` で貼り付け

**コピーされる内容**:
- セルの値
- 数式（相対参照として貼り付けられる）
- セルのスタイル（背景色など）
- 仮身オブジェクト

### 仮身操作

#### 仮身の配置

1. **ドラッグ＆ドロップ**
   - 仮身一覧や他のウィンドウから仮身をドラッグ
   - セルにドロップ

2. **コピー＆ペースト**
   - 仮身を含むセルを `Ctrl+C` でコピー
   - 別のセルに `Ctrl+V` で貼り付け

#### 仮身の移動とコピー

- **移動（デフォルト）**: 仮身をドラッグ
  - ドラッグ元の仮身は消えて、ドラッグ先に移動

- **コピー**: 左クリックでドラッグ中に右クリック
  1. 仮身を左クリックでドラッグ開始
  2. ドラッグ中に右クリックを押す
  3. 左クリックを先に離す
  4. 右クリックを離す
  - ドラッグ元の仮身は残り、ドラッグ先にコピーされる

#### 仮身の複製（実身複製）

**ダブルクリックドラッグ**で実身を複製できます：

1. 仮身を素早くダブルクリック
2. そのままドラッグ（マウスボタンを離さない）
3. ドロップ先で離す
4. 実身複製ダイアログが表示される
5. 新しい実身の名前を入力して確定

→ 新しい実身が作成され、その仮身がドロップ先に配置される

#### 仮身の起動

- **ダブルクリック**: 仮身をダブルクリックして実身を開く
  - 実身に対応したプラグインが起動します

### 行・列のリサイズ

#### 列幅の変更
1. 列ヘッダー（A, B, C...）の右端にマウスを合わせる
2. カーソルが ↔ に変わる
3. ドラッグして幅を調整

#### 行の高さの変更
1. 行ヘッダー（1, 2, 3...）の下端にマウスを合わせる
2. カーソルが ↕ に変わる
3. ドラッグして高さを調整

**保存**: リサイズ情報はファイル保存時に一緒に保存されます

### セルの範囲選択

1. **単一セルの選択**: セルをクリック
2. **範囲選択**: セルをクリックしてドラッグ
3. **複数選択**: Ctrlキーを押しながらセルをクリック

### ショートカットキー

| キー | 操作 |
|------|------|
| `Enter` | セル編集を確定して下に移動 |
| `Tab` | セル編集を確定して右に移動 |
| `Esc` | セル編集をキャンセル |
| `Ctrl+C` | セルをコピー |
| `Ctrl+V` | セルを貼り付け |
| `Ctrl+S` | ファイルを保存 |
| `Delete` | セルの内容を削除 |
| `F2` | セルを編集モードにする |

## ファイル形式

### 保存形式
- **TAD形式**: BTRON標準のTAD (Text And Draw) 形式
- **実身/仮身構造**: BTRONの実身/仮身システムに準拠

### ファイル構成
- `.json`: メタデータ（実身ID、作成日時など）
- `_0.xtad`: 実際のデータ（XML形式のTAD）
- `.ico`: アイコンファイル（オプション）

### TAD XMLタグ

表計算データは以下のXMLタグで保存されます：

```xml
<calcCell col="列番号" row="行番号">
  <value>値</value>
  <formula>数式</formula>
  <displayValue>表示値</displayValue>
  <contentType>セルタイプ</contentType>
  <!-- スタイル情報 -->
  <!-- 仮身情報 -->
</calcCell>
```

列幅・行の高さのカスタマイズは以下のタグで保存されます：

```xml
<calcSize>
  <colWidth col="列番号">幅</colWidth>
  <rowHeight row="行番号">高さ</rowHeight>
</calcSize>
```

仮身は標準のTAD `<link>` タグで保存されます：

```xml
<link linkId="実身ID" linkName="仮身名" ...>
```

## 技術仕様

### セルデータ構造

各セルは以下のプロパティを持ちます：

```javascript
{
  value: '',              // セルの値
  formula: '',            // 数式（= で始まる）
  displayValue: '',       // 表示される値（計算結果）
  style: {},              // スタイル情報
  virtualObject: null,    // 仮身オブジェクト
  contentType: 'text'     // 'text', 'formula', 'virtualObject'
}
```

### 計算エンジン

- **数式評価**: JavaScriptの`eval()`を使用
- **セル参照の解決**: A1形式と[行,列]形式に対応
- **循環参照検出**: 評価中セットで循環を検出
- **依存関係の再計算**: セル変更時に依存セルを自動再計算

### プラグインAPI

親ウィンドウとの通信は`postMessage`を使用：

- `init`: プラグイン初期化
- `save-request`: 保存要求
- `read-icon-file`: アイコン読み込み要求
- `duplicate-real-object`: 実身複製要求

## 制限事項

1. **数式のセキュリティ**: `eval()`を使用しているため、任意のJavaScriptコードが実行可能です。信頼できないファイルを開く際は注意が必要です。

2. **Formula.jsの一部機能**: Formula.jsの399個の関数のうち、一部の高度な関数（動的配列関数など）は未対応の可能性があります。

3. **グラフ機能**: グラフ作成機能は現在未実装です。

4. **セルの書式設定**: 数値フォーマット（通貨、パーセンテージなど）の詳細な書式設定は現在未実装です。

5. **大規模データ**: 数千行を超える大規模データでは、パフォーマンスが低下する可能性があります。

## 使用ライブラリ

- **Formula.js** (v2.9.3+): Microsoft Excel互換の399個の関数を提供
  - 統計、数学、論理、テキスト、日付、財務、検索、エンジニアリング関数など
  - 公式サイト: [https://formulajs.info/](https://formulajs.info/)
  - GitHubリポジトリ: [https://github.com/formulajs/formulajs](https://github.com/formulajs/formulajs)
  - ライセンス: MIT License (Copyright (c) 2014 Sutoiku, Inc.)
- **jStat** (v1.9.2+): JavaScriptの統計ライブラリ
  - Formula.jsが内部で使用
  - GitHubリポジトリ: [https://github.com/jstat/jstat](https://github.com/jstat/jstat)
  - ライセンス: MIT License

## 今後の拡張予定

- グラフ作成機能
- セルの書式設定（数値フォーマット、文字揃え）
- フィルタ・ソート機能
- 条件付き書式
- ピボットテーブル

## ライセンス

### 基本表計算プラグイン

MIT License

Copyright (c) 2025 satromi

本プラグインは、以下のオープンソースライブラリを使用しています。

### 使用ライブラリのライセンス

#### Formula.js

MIT License
Copyright (c) 2014 Sutoiku, Inc.

Formula.jsは以下の第三者ライブラリを含んでいます：
- Bessel Functions - Copyright (c) 2013 SheetJS (MIT License)
- jStat (JavaScript Statistical Library) - Copyright (c) 2013 jStat (MIT License)

完全なライセンステキストは [`lib/FORMULA.JS-LICENSE.txt`](lib/FORMULA.JS-LICENSE.txt) を参照してください。

#### jStat

MIT License
Copyright (c) jStat contributors

本プラグインに含まれるすべてのライブラリはMITライセンスの下で配布されており、自由に使用、変更、配布することができます。

## 作者

satromi

## 関連リンク

- [TADjs Desktop](https://github.com/satromi/tadjs)
- [プラグイン開発ガイド](../../pluginBuildGuide.md)
